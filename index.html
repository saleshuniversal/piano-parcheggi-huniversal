<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Parcheggio - Hotel Universal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 26px;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            background: white;
            padding: 20px 30px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .legend {
            padding: 15px 30px;
            background: #f9fafb;
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
        
        .parking-grid {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
        }
        
        th {
            background: #f3f4f6;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th.posto-header {
            background: #1e3a8a;
            color: white;
            font-size: 13px;
            min-width: 100px;
        }
        
        td {
            padding: 8px 4px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
            min-height: 60px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
            position: relative;
        }
        
        td:not(.occupied):hover {
            transform: scale(1.02);
            z-index: 5;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Stili per le prenotazioni con bordi continui */
        .occupied {
            background: #fee2e2;
            border-top: 3px solid #dc2626 !important;
            border-bottom: 3px solid #dc2626 !important;
            cursor: grab !important;
        }
        
        .occupied:active {
            cursor: grabbing !important;
        }
        
        .occupied.reservation-start {
            border-left: 3px solid #dc2626 !important;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .occupied.reservation-end {
            border-right: 3px solid #dc2626 !important;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .occupied.reservation-single {
            border: 3px solid #dc2626 !important;
            border-radius: 8px;
        }
        
        /* Stile per overbooking */
        .overbooking {
            background: repeating-linear-gradient(
                45deg,
                #fca5a5,
                #fca5a5 10px,
                #ef4444 10px,
                #ef4444 20px
            ) !important;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.7; }
        }
        
        .free {
            background: #d1fae5;
        }
        
        /* Stile per drag & drop */
        .dragging {
            opacity: 0.5;
        }
        
        .drag-over {
            background: #fef3c7 !important;
            border: 3px dashed #f59e0b !important;
        }
        
        /* Tooltip migliorato - posizionato SOPRA la cella */
        #globalTooltip {
            visibility: hidden;
            position: fixed;
            background-color: #1f2937;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            min-width: 250px;
            max-width: 350px;
            pointer-events: auto;
        }
        
        .tooltip-header {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            color: #60a5fa;
        }
        
        .tooltip-row {
            margin: 6px 0;
            display: flex;
            gap: 8px;
        }
        
        .tooltip-label {
            font-weight: 600;
            color: #9ca3af;
            min-width: 80px;
        }
        
        .tooltip-value {
            color: white;
        }
        
        .tooltip-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .tooltip-btn {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tooltip-btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .tooltip-btn-edit:hover {
            background: #2563eb;
        }
        
        .tooltip-btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .tooltip-btn-delete:hover {
            background: #dc2626;
        }
        
        .zone-1-8 .posto-header { background: #0ea5e9 !important; }
        .zone-9-27 .posto-header { background: #8b5cf6 !important; }
        .zone-electric .posto-header { background: #10b981 !important; }
        .zone-h .posto-header { background: #ef4444 !important; }
        .zone-navetta .posto-header { background: #06b6d4 !important; }
        .zone-bidoni .posto-header { background: #92400e !important; }
        .zone-esterni .posto-header { background: #059669 !important; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .modal-header h2 {
            color: #1e3a8a;
            font-size: 22px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #6b7280;
        }
        
        .info-banner {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 15px 20px;
            margin: 20px 30px;
            border-radius: 6px;
            font-size: 13px;
            color: #1e40af;
        }
        
        .info-banner strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Piano Parcheggio - Hotel Universal</h1>
            <div class="sync-indicator">
                <div class="sync-dot"></div>
                <span>Sincronizzato</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Mese</label>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="0">Gennaio</option>
                    <option value="1">Febbraio</option>
                    <option value="2">Marzo</option>
                    <option value="3">Aprile</option>
                    <option value="4">Maggio</option>
                    <option value="5">Giugno</option>
                    <option value="6">Luglio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Settembre</option>
                    <option value="9">Ottobre</option>
                    <option value="10">Novembre</option>
                    <option value="11">Dicembre</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Anno</label>
                <select id="yearSelect" onchange="changeMonth()">
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Cerca</label>
                <input type="text" id="searchGuest" placeholder="Ospite..." oninput="searchGuest()">
            </div>
            
            <button class="btn btn-primary" onclick="showAddModal()" style="margin-top: 20px;">‚ûï Nuova</button>
        </div>
        
        <div class="info-banner">
            <strong>üí° Come funziona:</strong>
            TRASCINA per spostare ‚Ä¢ DOPPIO CLICK per modificare ‚Ä¢ Passa il MOUSE per vedere dettagli e pulsanti
        </div>
        
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background: #d1fae5;"></div><span>Libero</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #fee2e2; border: 3px solid #dc2626; border-radius: 4px;"></div><span>Occupato</span></div>
            <div class="legend-item"><div class="legend-color" style="background: repeating-linear-gradient(45deg, #fca5a5, #fca5a5 5px, #ef4444 5px, #ef4444 10px); border-radius: 4px;"></div><span>Overbooking</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>PK 16-17 ‚ö°</span></div>
        </div>
        
        <div class="parking-grid">
            <div class="loading" id="loading">Caricamento...</div>
            <table id="parkingTable" style="display: none;">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuova Prenotazione</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <form onsubmit="saveReservation(event)">
                <input type="hidden" id="reservationId">
                <div class="form-group">
                    <label>Ospite *</label>
                    <input type="text" id="guestName" required placeholder="ROSSI MARIO">
                </div>
                <div class="form-group">
                    <label>Posto *</label>
                    <select id="parkingSpot" required><option value="">Seleziona...</option></select>
                </div>
                <div class="form-group">
                    <label>Arrivo *</label>
                    <input type="date" id="checkInDate" required>
                </div>
                <div class="form-group">
                    <label>Partenza *</label>
                    <input type="date" id="checkOutDate" required>
                </div>
                <div class="form-group">
                    <label>Targa</label>
                    <input type="text" id="licensePlate" placeholder="AB123CD">
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="notes"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteReservation()" id="deleteBtn" style="display: none;">üóëÔ∏è Elimina</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" style="background: #6b7280; color: white;" onclick="closeModal()">Annulla</button>
                        <button type="submit" class="btn btn-success">üíæ Salva</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tooltip globale -->
    <div id="globalTooltip"></div>
    
    <script>
        const SUPABASE_URL = 'https://nsettzmyswlfrnzwvpsq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZXR0em15c3dsZnJuend2cHNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzA0NzIsImV4cCI6MjA4MTYwNjQ3Mn0.OA2B7-6PVOi8XSaM5_r0Dxv_wpbG5I_ImTxaR0sgUoY';
        
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const parkingSpots = ['PK 1','PK 2','PK 3','PK 4','PK 5','PK 6','PK 7','PK 8','PK 9','PK 10','PK 11','PK 12','PK 13','PK 14','PK 15','PK 16','PK 17','PK 18','PK 19','PK 20','PK 21','PK 22','PK 23','PK 24','PK 25','PK 26','PK 27','PK H','NAVETTA','PK ESTERNI','BIDONI'];
        
        let reservations = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let draggedReservation = null;
        let cellReservationMap = new Map();
        let currentHoveredCell = null;
        let tooltipHideTimer = null;
        
        function getZoneClass(spot) {
            const num = parseInt(spot.replace('PK ',''));
            if(num>=1&&num<=8)return'zone-1-8';
            if(num===16||num===17)return'zone-electric';
            if(num>=9&&num<=27)return'zone-9-27';
            if(spot==='PK H')return'zone-h';
            if(spot==='NAVETTA')return'zone-navetta';
            if(spot==='BIDONI')return'zone-bidoni';
            if(spot==='PK ESTERNI')return'zone-esterni';
            return'';
        }
        
        function getSpotIcon(spot){
            const num=parseInt(spot.replace('PK ',''));
            return(num===16||num===17)?' ‚ö°':'';
        }
        
        async function loadReservations(){
            const{data,error}=await sb.from('reservations').select('*');
            if(error){alert('Errore caricamento');return;}
            reservations=data||[];
            document.getElementById('loading').style.display='none';
            document.getElementById('parkingTable').style.display='table';
            renderCalendar();
        }
        
        function init(){
            populateParkingSpots();
            document.getElementById('monthSelect').value=currentMonth;
            document.getElementById('yearSelect').value=currentYear;
            setupTooltipEvents();
            loadReservations();
            sb.channel('reservations_changes').on('postgres_changes',{event:'*',schema:'public',table:'reservations'},()=>{loadReservations();}).subscribe();
        }
        
        function populateParkingSpots(){
            const select=document.getElementById('parkingSpot');
            parkingSpots.forEach(spot=>{
                const option=document.createElement('option');
                option.value=spot;
                option.textContent=spot+getSpotIcon(spot);
                select.appendChild(option);
            });
        }
        
        function changeMonth(){
            currentMonth=parseInt(document.getElementById('monthSelect').value);
            currentYear=parseInt(document.getElementById('yearSelect').value);
            renderCalendar();
        }
        
        function getDaysInMonth(month,year){
            return new Date(year,month+1,0).getDate();
        }
        
        function getDayInitials(date){
            const days=['DOM','LUN','MAR','MER','GIO','VEN','SAB'];
            return days[date.getDay()];
        }
        
        function getReservationsForDate(spot,dateStr){
            return reservations.filter(res=>res.spot===spot&&dateStr>=res.check_in_date&&dateStr<res.check_out_date);
        }
        
        function formatDate(dateStr){
            const date=new Date(dateStr+'T00:00:00');
            return date.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
        }
        
        function showTooltip(event,cellKey){
            const res=cellReservationMap.get(cellKey);
            if(!res)return;
            
            // Cancella qualsiasi timer di nascondimento
            if(tooltipHideTimer){
                clearTimeout(tooltipHideTimer);
                tooltipHideTimer=null;
            }
            
            currentHoveredCell=event.currentTarget;
            
            const tooltip=document.getElementById('globalTooltip');
            
            let html='<div class="tooltip-header">'+res.guest_name+'</div>';
            html+='<div class="tooltip-row"><span class="tooltip-label">Check-in:</span><span class="tooltip-value">'+formatDate(res.check_in_date)+'</span></div>';
            html+='<div class="tooltip-row"><span class="tooltip-label">Check-out:</span><span class="tooltip-value">'+formatDate(res.check_out_date)+'</span></div>';
            if(res.license_plate){
                html+='<div class="tooltip-row"><span class="tooltip-label">Targa:</span><span class="tooltip-value">'+res.license_plate+'</span></div>';
            }
            if(res.notes){
                html+='<div class="tooltip-row"><span class="tooltip-label">Note:</span><span class="tooltip-value">'+res.notes+'</span></div>';
            }
            html+='<div class="tooltip-actions">';
            html+='<button class="tooltip-btn tooltip-btn-edit" onclick="editFromTooltip(\''+cellKey+'\')">‚úèÔ∏è Modifica</button>';
            html+='<button class="tooltip-btn tooltip-btn-delete" onclick="deleteFromTooltip(\''+cellKey+'\')">üóëÔ∏è Elimina</button>';
            html+='</div>';
            
            tooltip.innerHTML=html;
            tooltip.style.visibility='visible';
            positionTooltip(event.currentTarget);
        }
        
        function scheduleHideTooltip(){
            // Aspetta 300ms prima di nascondere
            tooltipHideTimer=setTimeout(function(){
                hideTooltip();
            },300);
        }
        
        function cancelHideTooltip(){
            if(tooltipHideTimer){
                clearTimeout(tooltipHideTimer);
                tooltipHideTimer=null;
            }
        }
        
        function positionTooltip(cell){
            const tooltip=document.getElementById('globalTooltip');
            const rect=cell.getBoundingClientRect();
            
            const tooltipHeight=tooltip.offsetHeight;
            let top=rect.top-tooltipHeight-10;
            let left=rect.left+(rect.width/2)-(tooltip.offsetWidth/2);
            
            if(top<0){
                top=rect.bottom+10;
            }
            
            if(left<10){
                left=10;
            }
            if(left+tooltip.offsetWidth>window.innerWidth-10){
                left=window.innerWidth-tooltip.offsetWidth-10;
            }
            
            tooltip.style.left=left+'px';
            tooltip.style.top=top+'px';
        }
        
        function hideTooltip(){
            document.getElementById('globalTooltip').style.visibility='hidden';
            currentHoveredCell=null;
            if(tooltipHideTimer){
                clearTimeout(tooltipHideTimer);
                tooltipHideTimer=null;
            }
        }
        
        function setupTooltipEvents(){
            const tooltip=document.getElementById('globalTooltip');
            tooltip.addEventListener('mouseenter',function(){
                cancelHideTooltip();
            });
            tooltip.addEventListener('mouseleave',function(){
                hideTooltip();
            });
        }
        
        document.addEventListener('click',function(e){
            const tooltip=document.getElementById('globalTooltip');
            if(tooltip.style.visibility==='visible'&&!tooltip.contains(e.target)&&!e.target.classList.contains('occupied')){
                hideTooltip();
            }
        });
        
        function editFromTooltip(cellKey){
            hideTooltip();
            const res=cellReservationMap.get(cellKey);
            if(!res)return;
            openModalWithReservation(res);
        }
        
        async function deleteFromTooltip(cellKey){
            hideTooltip();
            const res=cellReservationMap.get(cellKey);
            if(!res)return;
            if(!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare la prenotazione di '+res.guest_name+'?'))return;
            const{error}=await sb.from('reservations').delete().eq('id',res.id);
            if(error){
                alert('‚ùå Errore nell\'eliminazione');
                return;
            }
            alert('üóëÔ∏è Prenotazione eliminata!');
            loadReservations();
        }
        
        function renderCalendar(){
            cellReservationMap.clear();
            const daysInMonth=getDaysInMonth(currentMonth,currentYear);
            const tableHead=document.getElementById('tableHead');
            const tableBody=document.getElementById('tableBody');
            let headerHTML='<tr><th class="posto-header">Posto</th>';
            for(let day=1;day<=daysInMonth;day++){
                const date=new Date(currentYear,currentMonth,day);
                const dayInitials=getDayInitials(date);
                headerHTML+='<th>'+day+'<br><small style="font-size:9px;">'+dayInitials+'</small></th>';
            }
            headerHTML+='</tr>';
            tableHead.innerHTML=headerHTML;
            
            let bodyHTML='';
            
            parkingSpots.forEach(spot=>{
                const zoneClass=getZoneClass(spot);
                const spotIcon=getSpotIcon(spot);
                bodyHTML+='<tr class="'+zoneClass+'"><td class="posto-header">'+spot+spotIcon+'</td>';
                
                for(let day=1;day<=daysInMonth;day++){
                    const year=currentYear;
                    const month=String(currentMonth+1).padStart(2,'0');
                    const dayStr=String(day).padStart(2,'0');
                    const dateStr=`${year}-${month}-${dayStr}`;
                    
                    const resList=getReservationsForDate(spot,dateStr);
                    const cellKey=spot+'-'+dateStr;
                    
                    let cellClass='free';
                    let borderClass='';
                    let cellAttrs='';
                    
                    if(resList.length>0){
                        const res=resList[0];
                        cellReservationMap.set(cellKey,res);
                        
                        const isStart=(res.check_in_date===dateStr);
                        const checkOutDate=new Date(res.check_out_date+'T00:00:00');
                        const dayBeforeCheckout=new Date(checkOutDate);
                        dayBeforeCheckout.setDate(dayBeforeCheckout.getDate()-1);
                        const yearEnd=dayBeforeCheckout.getFullYear();
                        const monthEnd=String(dayBeforeCheckout.getMonth()+1).padStart(2,'0');
                        const dayEnd=String(dayBeforeCheckout.getDate()).padStart(2,'0');
                        const isEnd=(`${yearEnd}-${monthEnd}-${dayEnd}`===dateStr);
                        
                        if(isStart&&isEnd){
                            borderClass='reservation-single';
                        }else if(isStart){
                            borderClass='reservation-start';
                        }else if(isEnd){
                            borderClass='reservation-end';
                        }
                        
                        if(resList.length>1){
                            cellClass='occupied overbooking '+borderClass;
                        }else{
                            cellClass='occupied '+borderClass;
                        }
                        
                        cellAttrs='draggable="true" data-res-id="'+res.id+'" data-cell-key="'+cellKey+'" onmouseenter="showTooltip(event,\''+cellKey+'\')" onmouseleave="scheduleHideTooltip()" ondragstart="handleDragStart(event,\''+cellKey+'\')" ondragend="handleDragEnd(event)" ondblclick="openModalByDoubleClick(\''+cellKey+'\')"';
                    }else{
                        cellAttrs='onclick="openModal(\''+spot+'\',\''+dateStr+'\')"';
                    }
                    
                    bodyHTML+='<td class="'+cellClass+'" '+cellAttrs+' ondragover="handleDragOver(event)" ondrop="handleDrop(event,\''+spot+'\',\''+dateStr+'\')" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)"></td>';
                }
                bodyHTML+='</tr>';
            });
            tableBody.innerHTML=bodyHTML;
        }
        
        function openModalByDoubleClick(cellKey){
            const res=cellReservationMap.get(cellKey);
            if(!res)return;
            hideTooltip();
            openModalWithReservation(res);
        }
        
        function handleDragStart(event,cellKey){
            const res=cellReservationMap.get(cellKey);
            if(!res)return;
            draggedReservation=res;
            event.currentTarget.classList.add('dragging');
            hideTooltip();
        }
        
        function handleDragEnd(event){
            event.currentTarget.classList.remove('dragging');
            draggedReservation=null;
            document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
        }
        
        function handleDragOver(event){
            event.preventDefault();
        }
        
        function handleDragEnter(event){
            if(draggedReservation&&event.currentTarget.tagName==='TD'){
                event.currentTarget.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(event){
            event.currentTarget.classList.remove('drag-over');
        }
        
        async function handleDrop(event,newSpot,dateStr){
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if(!draggedReservation)return;
            
            const existingRes=getReservationsForDate(newSpot,dateStr);
            if(existingRes.length>0&&!confirm('‚ö†Ô∏è Attenzione: c\'√® gi√† una prenotazione su questo posto nelle stesse date. Vuoi creare un overbooking temporaneo?')){
                return;
            }
            
            const{error}=await sb.from('reservations').update({spot:newSpot}).eq('id',draggedReservation.id);
            
            if(error){
                alert('‚ùå Errore nello spostamento');
                return;
            }
            
            alert('‚úÖ Prenotazione spostata con successo!');
            loadReservations();
        }
        
        function showAddModal(){
            document.getElementById('modalTitle').textContent='Nuova Prenotazione';
            document.getElementById('reservationId').value='';
            document.getElementById('guestName').value='';
            document.getElementById('parkingSpot').value='';
            document.getElementById('checkInDate').value='';
            document.getElementById('checkOutDate').value='';
            document.getElementById('licensePlate').value='';
            document.getElementById('notes').value='';
            document.getElementById('deleteBtn').style.display='none';
            document.getElementById('reservationModal').classList.add('active');
        }
        
        function openModalWithReservation(res){
            document.getElementById('modalTitle').textContent='Modifica Prenotazione';
            document.getElementById('reservationId').value=res.id;
            document.getElementById('guestName').value=res.guest_name;
            document.getElementById('parkingSpot').value=res.spot;
            document.getElementById('checkInDate').value=res.check_in_date;
            document.getElementById('checkOutDate').value=res.check_out_date;
            document.getElementById('licensePlate').value=res.license_plate||'';
            document.getElementById('notes').value=res.notes||'';
            document.getElementById('deleteBtn').style.display='block';
            document.getElementById('reservationModal').classList.add('active');
        }
        
        function openModal(spot,dateStr){
            const resList=getReservationsForDate(spot,dateStr);
            if(resList.length>0){
                openModalWithReservation(resList[0]);
            }else{
                document.getElementById('modalTitle').textContent='Nuova Prenotazione';
                document.getElementById('reservationId').value='';
                document.getElementById('guestName').value='';
                document.getElementById('parkingSpot').value=spot;
                document.getElementById('checkInDate').value=dateStr;
                document.getElementById('checkOutDate').value='';
                document.getElementById('licensePlate').value='';
                document.getElementById('notes').value='';
                document.getElementById('deleteBtn').style.display='none';
                document.getElementById('reservationModal').classList.add('active');
            }
        }
        
        function closeModal(){
            document.getElementById('reservationModal').classList.remove('active');
        }
        
        async function saveReservation(event){
            event.preventDefault();
            const id=document.getElementById('reservationId').value;
            const data={
                spot:document.getElementById('parkingSpot').value,
                guest_name:document.getElementById('guestName').value,
                check_in_date:document.getElementById('checkInDate').value,
                check_out_date:document.getElementById('checkOutDate').value,
                license_plate:document.getElementById('licensePlate').value,
                notes:document.getElementById('notes').value
            };
            if(data.check_in_date>=data.check_out_date){
                alert('‚ö†Ô∏è La data di partenza deve essere successiva alla data di arrivo!');
                return;
            }
            let result;
            if(id){
                result=await sb.from('reservations').update(data).eq('id',id);
            }else{
                result=await sb.from('reservations').insert([data]);
            }
            if(result.error){
                alert('‚ùå Errore nel salvataggio');
                return;
            }
            closeModal();
            alert('‚úÖ Prenotazione salvata con successo!');
            loadReservations();
        }
        
        async function deleteReservation(){
            if(!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questa prenotazione?'))return;
            const id=document.getElementById('reservationId').value;
            const{error}=await sb.from('reservations').delete().eq('id',id);
            if(error){
                alert('‚ùå Errore nell\'eliminazione');
                return;
            }
            closeModal();
            alert('üóëÔ∏è Prenotazione eliminata!');
            loadReservations();
        }
        
        function searchGuest(){
            const search=document.getElementById('searchGuest').value.toLowerCase();
            if(!search){
                document.querySelectorAll('#tableBody tr').forEach(row=>row.style.display='');
                return;
            }
            
            const matchingReservations=reservations.filter(res=>
                res.guest_name.toLowerCase().includes(search)||
                (res.license_plate&&res.license_plate.toLowerCase().includes(search))
            );
            
            const matchingSpots=new Set(matchingReservations.map(res=>res.spot));
            
            document.querySelectorAll('#tableBody tr').forEach(row=>{
                const spotCell=row.querySelector('.posto-header');
                if(spotCell){
                    const spotName=spotCell.textContent.trim().replace('‚ö°','').trim();
                    row.style.display=matchingSpots.has(spotName)||!search?'':'none';
                }
            });
        }
        
        window.onload=init;
    </script>
</body>
</html>
